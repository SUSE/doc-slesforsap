<?xml version="1.0"?>
<!DOCTYPE chapter [
  <!ENTITY % entities SYSTEM "generic-entities.ent">
  %entities;
]>

<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="cha-upgrade-sap-hana-cluster">
 <title>Upgrading an &hana; cluster</title>
 <info xmlns:d="http://docbook.org/ns/docbook">
  <abstract>
   <para>
    This chapter describes how to upgrade your &hana; cluster
    with the &yast; module <guimenu>SUSE HANA Cluster Update</guimenu>.
    This acts as a wizard and guides you through all the &hana; cluster
    maintenance procedures.
   </para>
  </abstract>
 <revhistory xml:id="rh-cha-upgrade-sap-hana-cluster">
   <revision>
     <date>2022-06-17</date>
     <revdescription>
       <para/>
     </revdescription>
   </revision>
 </revhistory>
</info>

  <para>
   The official &hana; documentation describes the so-called <emphasis>Near
   Zero Downtime Upgrade Process</emphasis>. The &yast; module is based on
   this process and handles the part of the procedure related to the &suse;
   cluster. Not all steps can be done automatically. Some steps need to be
   performed manually by the &hana; administrator. The &yast; module will inform
   you during the process.
  </para>
  <para>
   This &yast; module is available in the <package>yast2-sap-ha</package>
   package for &productname; 12&nbsp;SP3 and higher.
   Currently, the wizard is only prepared to handle the
   <emphasis>&hana; Scale-up Performance Optimized</emphasis> scenario.
  </para>
  <para>The upgrade covers the following tasks:</para>
  <procedure>
   <step>
    <para><xref linkend="sec-upgrade-sap-hana-cluster-preparing"/></para>
   </step>
   <step>
    <para><xref linkend="sec-upgrade-sap-hana-cluster-upgrading"/></para>
   </step>
   <step>
    <para><xref linkend="sec-upgrade-sap-hana-cluster-finishing"/></para>
   </step>
  </procedure>

 <sect1 xml:id="sec-upgrade-sap-hana-cluster-preparing">
  <title>Preparing the upgrade</title>
  <procedure>
   <para>
    Ensure passwordless SSH access between the two nodes (primary and secondary) for &rootuser;.
    Keep in mind, some cloud service providers might not have set up SSH access
    for the &rootuser; by default.
   </para>
   <step>
    <para>
     Install the <package>yast2-hana-update</package> package on both nodes:
    </para>
    <screen>&prompt.root;<command>zypper</command> install yast2-hana-update</screen>
    <para>
     After the installation, you can find the module <guimenu>SUSE HANA
     Cluster Update</guimenu> in the &yastcc;.
    </para>
   </step>
   <step>
    <para>
     On the secondary node, start the &yastcc; and open the
     <guimenu>SUSE HANA Cluster Update</guimenu> module.
    </para>
   </step>
   <step>
    <para>
     In the &yast; module, review the prerequisites. Make sure to fulfill all
     of them before continuing with the next step. Keep in mind that the
     wizard supports only the HANA Scale-up Performance Optimized scenario.
    </para>
   </step>
   <step>
    <para>
     To upgrade the &hana; system, select the secondary node.
    </para>
   </step>
   <step>
    <para>
     Select the location of the installation medium.
    </para>
    <para>
     Point to the location where the &sap; medium is located. If wanted, check
     <guimenu>Mount an update medium on all hosts</guimenu> and provide the NFS
     share and path.
    </para>
    <important>
     <title>Differences between &hana; version 1.0 and 2.0</title>
     <para>
      If you are upgrading from &hana; version&nbsp;1.0 to version&nbsp;2.0,
      make sure to check <guimenu>This is a HANA 1.0 to HANA 2.0 upgrade</guimenu>.
     </para> 
     <para>
      The &yast; module will copy the <emphasis>PKI SSFS keys</emphasis> from
      the former secondary node to the former primary node. More information is
      available through the <guimenu>Help</guimenu> button.
     </para>
    </important>
   </step>
  </procedure>
  <para>
   Continue with <xref linkend="sec-upgrade-sap-hana-cluster-upgrading"/>.
  </para>
 </sect1>

 <sect1 xml:id="sec-upgrade-sap-hana-cluster-upgrading">
  <title>Upgrading your &hana; cluster</title>
  <para/>
  <procedure>
   <step>
    <para>
     Review the update plan generated by the wizard.
    </para>
    <para>
     The wizard shows you two steps: automatic and manual. In this automatic
     step, the wizard puts cluster resources into maintenance mode before it
     starts with the automatic steps. The manual steps are &hana; specific and
     need to be executed by an &hana; administrator. For more information, see
     the official &hana; documentation.
    </para>
   </step>
   <step>
    <para>
     Update the &hana; software.
    </para>
    <para>
     The wizard executes the automatic actions and waits until the &hana;
     administrator performs the &hana; upgrade.
    </para>
   </step>
   <step>
    <para>
     Perform the &hana; upgrade.
    </para>
   </step>
   <step>
    <para>
     Review the plan for the primary (remote) node.
    </para>
    <para>
     After the &hana; upgrade is done, the wizard shows the
     update plan. When you continue with this step, the wizard turns the
     primary node into a secondary node to make it ready for the upgrade.
    </para>
    <para>
     Keep in mind that this step can take some time.
    </para>
   </step>
  </procedure>
  <para>
   Continue with <xref linkend="sec-upgrade-sap-hana-cluster-finishing"/>.
  </para>
 </sect1>

 <sect1 xml:id="sec-upgrade-sap-hana-cluster-finishing">
  <title>Finishing the upgrade task</title>
  <para/>
  <procedure>
   <step>
   <para>
    Update the former primary node.
   </para>
   <para>
    Pay special attention to the <option>--hdbupd_server_nostart</option>
    option in this step.
   </para>
  </step>
  <step>
   <para>
    Restore the previous state of the cluster.
   </para>
   <para>
    By default, the wizard registers the former master as now being secondary on
    the &hana; system replication. If you want to revert the system
    replication to its original state, click the <guimenu>Reverse</guimenu>
    button.
   </para>
  </step>
   <step>
    <para>
     Review the update summary.
    </para>
    <para>
     You can review the original and current &hana; versions and the cluster
     state.
    </para>
    <note>
     <title>Dealing with intermediate cluster state</title>
     <para>
      If the wizard is faster than the status update of the cluster resources,
      the summary shows an intermediate cluster state. The cluster state is
      <literal>UNDEFINED</literal> or <literal>DEMOTED</literal>.
     </para>
     <para>
      To overcome this, check the cluster status again with the command
      <command>SAPHanaSR-showAttr</command> and make sure the former
      secondary node is now in the state <literal>PROMOTED</literal>.
     </para>
    </note>
   </step>
  </procedure>

  <para>
   Refer to the &suse; blog post <link xlink:href="https://www.suse.com/c/how-to-upgrade-your-suse-sap-hana-cluster-in-an-easy-way/"/>
   for further information.
  </para>
 </sect1>

</chapter>
