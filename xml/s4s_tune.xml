<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="cha-s4s-tune">
 <title>Tuning</title>

 <para>
  This chapter presents information about tuning &s4sa; to work optimally with
  &sap; applications.
 </para>

 <note>
  <title>Choosing between <command>sapconf</command> and
   <command>saptune</command></title>
  <para>
   On &s4s; you have the choice between <command>sapconf</command> and
   <command>saptune</command>. However, <command>saptune</command> is
   the more elaborate tool that offers more features.
  </para>
 </note>

 <sect1 xml:id="sec-s4s-configure-page-cache">
  <title>Kernel: Page-Cache Limit</title>
  <remark>
   The presentation of Problem/Solution is on one hand quite useful, on the
   other it is very inconsistent with the rest of this chapter.
   - sknorr, 2016-02-12
  </remark>
  <variablelist>
   <varlistentry>
    <term>Problem</term>
    <listitem>
     <para>
      The kernel swaps out rarely accessed memory pages to use
      freed memory pages as cache to speed up file system operations, for
      example during backup operations.
     </para>
     <para>
      &netweaver; and &hana; use large amounts of memory for accelerated access
      to business data. Parts of this memory are rarely accessed. When a
      user request needs to access paged-out memory, the response time
      is poor. It is even worse when an &sap; application running on Java incurs
      a Java garbage collection: The system starts heavy page-in (disc I/O)
      activity and has a poor response time for an extended period of time.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Solution</term>
    <listitem>
     <para>
      &sles4sap; includes a kernel tuning option that allows the system
      administrator to limit the amount of page cache that the kernel uses
      when there is competition between application memory and page cache.
      This option tells the kernel that when the page cache is filled to the
      configured limit, application memory is more important and should thus
      not be paged out. No pages will be paged out if the memory footprint
      of the workload plus the configured page-cache limit do not exceed the
      amount of physical RAM in the system.
     </para>
     <para>
      These kernel options are available for configuration:
     </para>
     <itemizedlist>
      <listitem>
       <para>
        <literal>vm.pagecache_limit_mb</literal>
        (<filename>/proc/sys/vm/pagecache_limit_mb</filename>)
       </para>
      </listitem>
      <listitem>
       <para>
        <literal>vm.pagecache_limit_ignore_dirty</literal>
        (<filename>/proc/sys/vm/pagecache_limit_ignore_dirty</filename>)
       </para>
      </listitem>
     </itemizedlist>
     <tip>
      <title>
       Use <systemitem>tuned</systemitem> to Configure These Parameters
      </title>
      <para>
       The parameters <literal>vm.pagecache_limit_mb</literal> and
       <literal>vm.pagecache_limit_ignore_dirty</literal> are also configured by
       the <systemitem>tuned</systemitem> profiles delivered with the
       package <systemitem>sapconf</systemitem>.
      </para>
      <para>
       For more information, see <xref linkend="sec-s4s-configure-sapconf"/>.
      </para>
     </tip>
     <important>
      <title>The Following Are Example Values</title>
      <para>
       The values reproduced in <xref linkend="ex-s4s-page-cache"/> are example
       values only. Do not set the following parameters on a productive system
       without first trying and calibrating them on a non-productive system.
      </para>
      <para>
       If your system does not exhibit page-cache limit issues under the
       workloads it is running, there is no need to adjust these parameters.
      </para>
      <para>
       For more information, see <citetitle>SAP Note 1557506: Linux Paging
       Improvements</citetitle>
       (<link xlink:href="&sapnoteaddress;1557506"/>).
     </para>
     </important>
     <example xml:id="ex-s4s-page-cache">
      <title>Permanently Setting the Page-Cache Limit</title>
      <para>
       For permanent use, add both parameters to
       <filename>/etc/sysctl.conf</filename>, for example:
      </para>
<screen>vm.pagecache_limit_mb = <replaceable>1024</replaceable>
vm.pagecache_limit_ignore_dirty = <replaceable>2</replaceable></screen>
     </example>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec-s4s-configure-sapconf">
  <title>Tuning Systems with <command>saptune</command></title>
  <para>
   Using &saptune;, you can
   tune a system for &netweaver;, &hana;/&bo;, and &s4h; applications. This method
   relies on the system tuning service &tuned;.
  </para>
  <para>
   If you used the &sapwiz; to install an &sap; application,
   <systemitem>tuned</systemitem> is usually already active and configured with
   a profile for the application you installed.
  </para>
  <para>
   If you did not use the &sapwiz; to install an &sap; application, make sure
   that the packages <package>tuned</package>, <package>saptune</package> and
   <systemitem>sapconf</systemitem> are installed on your system.
  </para>

  <sect2 xml:id="sec-s4s-saptune-enable">
  <title>Enabling <command>saptune</command> to Tune for an &sap; Application</title>
  <procedure xml:id="pro-s4s-tune">
   <step>
    <para>
     To tune a system, first find a tuning solutions.
     To find the appropriate solution, use:
    </para>
    <screen>&prompt.user;<command>saptune solution list</command></screen>
    <para>
     &saptune; knows the following tuning solutions (group of &sap; notes):
    </para>
    <itemizedlist>
     <listitem>
      <formalpara>
       <title><literal>BOBJ</literal></title>
       <para>
        Solution for running &bo;.
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>HANA</literal></title>
       <para>
        Solution for running a &hana; database.
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>MAXDB</literal></title>
       <para>
        Solution for running a &sap; MaxDB database.
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>NETWEAVER</literal></title>
       <para>
        Solution for running &netweaver; application servers.
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>S4HANA-APPSERVER</literal></title>
       <para> Solution for running &s4h; application servers
         (identical to &netweaver; solution). </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>S4HANA-APP+DB</literal></title>
       <para>Solution for running both &s4h; application servers and &hana;
        on the same host (identical to &netweaver; + &hana; solution). </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>S4HANA-DBSERVER</literal></title>
       <para>
        Solution for running the &hana; database of an &s4h;
        installation (identical to &hana; solution)
       </para>
      </formalpara>
     </listitem>
     <listitem>
      <formalpara>
       <title><literal>SAP-ASE</literal></title>
       <para>
        Solution for running an &ase; database.
       </para>
      </formalpara>
     </listitem>
    </itemizedlist>
    <para>
     Alternatively, you can tune the computer according to recommendations
     from specific &sap; Notes. A list of notes that you can tune for is
     available via:
    </para>
    <screen>&prompt.root;<command>saptune note list</command></screen>
   </step>
   <step>
    <itemizedlist>
     <listitem>
      <para>
       To set up <command>saptune</command> with a preconfigured solution, use:
      </para>
      <screen>&prompt.root;<command>saptune solution apply <replaceable>SOLUTION</replaceable></command></screen>
     </listitem>
     <listitem>
      <para>
       To set up <command>saptune</command> for the recommendations of a specific
       &sap; Note, use:
      </para>
      <screen>&prompt.root;<command>saptune note apply <replaceable>NOTE</replaceable></command></screen>
     </listitem>
    </itemizedlist>
    <note>
     <title>Combining Optimizations</title>
     <para>
      You can combine solutions and notes. However, you can only have
      one solution.
      In rare cases, notes can have conflicting options or parameters.
      To avoid conflicts, order your notes, keeping in mind that the
      last note always overrides the conflicting options or parameters
      in previous notes.
     </para>
    </note>
   </step>
   <step>
    <para>
     To start &saptune; and enable it at boot, make sure to run
     the following command:
    </para>
    <screen>&prompt.root;<command>saptune daemon start</command></screen>
   </step>
  </procedure>
  <para>
   In the background, <command>saptune</command> applies a
   <systemitem class="resource">tuned</systemitem> profile also named
   <command>saptune</command> that is dynamically customized according to
   selected <quote>solutions</quote> and <quote>notes</quote>.
   Using <command>tuned-adm list</command>, you can also see this profile.
  </para>
  </sect2>
  <sect2 xml:id="sec-s4s-saptune-customize">
   <title>Customizing a &sap; Note</title>
   <para>
    Every &sap; note can be configured freely with:
    <remark>toms 2019-07-08: Is it customise or customize?</remark>
   </para>
   <screen>&prompt.root;<command>saptune note customise</command></screen>
   <para>
    The command includes changing a value or disabling a parameter.
   </para>
  </sect2>

  <sect2 xml:id="sec-s4s-saptune-create">
   <title>Creating a new &sap; Note</title>
   <para>
     It is possible to create a new &sap; note with:
   </para>
   <screen>&prompt.root;<command>saptune note create</command></screen>
   <para>All features of &saptune; are available.</para>
  </sect2>

  <sect2 xml:id="sec-s4s-saptune-delete">
   <title>Deleting a &sap; Note</title>
   <para>
    This command allows to delete a created note, including the corresponding override
    file if available:
   </para>
   <screen>&prompt.root;<command>saptune note delete test</command>
Note to delete is a customer/vendor specific Note.
Do you really want to delete this Note (test2)? [y/n]: y</screen>
   <para>
    The note may not be applied at the time. Keep in mind the following points:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      A confirmation is needed to finish the action.
     </para>
    </listitem>
    <listitem>
     <para>
      Internal &sap; notes shipped by &saptune; cannot be deleted.
      Instead, the override file is removed when available.
     </para>
    </listitem>
    <listitem>
     <para>
      If the note is already applied, the command will be terminated with the
      information, that the note first needs to be reverted before it can be deleted.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-s4s-saptune-rename">
   <title>Renaming a &sap; Note</title>
   <para>
    This command allows to rename a created note to a new name.
    If a corresponding override file is available, this file will be renamed too:
   </para>
   <screen>&prompt.root;<command>saptune note rename test test2</command>
Note to rename is a customer/vendor specific Note.
Do you really want to rename this Note (test) to the new name 'test2'? [y/n]: y</screen>
   <para>
    The note may not be applied at the time.
    Keep in mind the following points:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      A confirmation is needed to finish the action.
     </para>
    </listitem>
    <listitem>
     <para>
      Internal &sap; notes shipped by &saptune; cannot be renamed.
     </para>
    </listitem>
    <listitem>
     <para>
      If the note is already applied, the command will be terminated with the
      information, that the note first needs to be reverted before it can be deleted.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-s4s-saptune-show">
   <title>Showing the Configuration of an &sap; Note</title>
   <para>
    The shipped configuration of a note can be listed with:
   </para>
   <screen>&prompt.root;<command>saptune note show</command></screen>
  </sect2>

  <sect2 xml:id="sec-s4s-saptune-verify">
   <title>Verifying a &sap; Note or a &sap; Solution</title>
   <para>
    The command <command>saptune note|solution verify [note]</command>
    lists for each active or requested note: the parameter name,
    the exected value (default), a configured override (done by a
    <command>saptune customise</command>) the current system value and
    if the current state is compliant to the &sap; recommendation or not.
   </para>
  </sect2>

  <sect2 xml:id="sec-s4s-saptune-simulate">
   <title>Simulating the Apply of a &sap; Note or a &sap; Solution</title>
   <para>
    To show each parameter, use:
   </para>
   <screen>&prompt.root;<command>saptune note|solution simulate</command></screen>
   <para>
    It lists the current system value and the expected values (default and
    override is listed too).
   </para>
  </sect2>

  <sect2 xml:id="sec-s4s-saptune-disable">
   <title>Disabling &saptune;</title>
   <para>
    To disable &saptune; and to stop and disable &tuned; run:
   </para>
   <screen>&prompt.root;<command>saptune daemon stop</command></screen>
  </sect2>
  <sect2>
   <title>Tuning Kernel Parameters Manually Using <command>sysctl</command></title>
   <para>
    In addition to or instead of tuning kernel parameters using
    <command>saptune</command>, you can also use <command>sysctl</command> to
    make manual adjustments to kernel parameters. However, such changes using
    <command>sysctl</command> do not persist across reboots by default. To
    make them persist across reboots, add them to the file
    <filename>/etc/sysctl.conf</filename> (or another configuration file read
    by <command>sysctl</command>).
   </para>
   <tip>
    <para>If you plan to configure sysctl parameters for your SAP system,
     consider to use <command>saptune</command> as a central instance for
     managing your system configuration.</para>
   </tip>
   <para>
    <!-- FIXME: -> SLES docs: we don't seem to have any good section to
    reference here. Thisll do for the moment. - sknorr, 2017-05-04 -->
    For more information about <command>sysctl</command>, see the man pages
    <literal>sysctl(8)</literal>, <literal>sysctl.conf(5)</literal>, and
    <literal>sysctl.d(5)</literal>.
   </para>
  </sect2>

  <!-- Check whether we still need the following notes with 12 SP3... - sknorr,
  2016-11-23 -->
  <sect2 xml:id="sec-saptune-legacyprofile">
   <title>Legacy Profiles</title>
   <para>
    The <systemitem class="resource">tuned</systemitem> profiles
    <literal>sap-hana</literal> and <literal>sap-netweaver</literal> from the
    package <package>sapconf</package> exist for legacy reasons only. They
    have nothing to do with the <command>saptune</command> configuration.
   </para>
  </sect2>
  <sect2 xml:id="sec-saptune-legacysapconf">
   <title>Legacy Utility <command>sapconf</command></title>
   <para>
    The package <systemitem>sapconf</systemitem> contains the deprecated
    utility <command>sapconf</command>. <command>sapconf</command> also
    allows tuning for &sap; systems but is less comprehensive and offers less
    granularity than <command>saptune</command>. It will also only apply
    its profiles when no other <systemitem class="resource">tuned</systemitem>
    profile is set.
   </para>
   <para>
    If you previously used <command>sapconf</command>, the &sapwiz; will
    offer to migrate your system to using
    <command>saptune</command>. Additionally, enabling
    <command>saptune</command> will disable <command>sapconf</command>.
   </para>
   <para>
    To disable <command>sapconf</command> along with the underlying daemon
    <systemitem class="daemon">tuned</systemitem>, use:
   </para>
   <screen>&prompt.root;<command>systemctl disable sapconf tuned</command></screen>
  </sect2>

  <sect2 xml:id="sec-saptune-more">
   <title>For More Information</title>
  <para>
   See the following man pages:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     <command>man 8 saptune</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man 8 saptune_v1</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man 8 saptune_v2</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man 8 saptune-migrate</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man 8 saptune-note</command>
    </para>
   </listitem>
  </itemizedlist>
  <para>
   Also see the project home page
   <link xlink:href="https://github.com/SUSE/saptune/"/>.
  </para>
  </sect2>
 </sect1>

 <sect1 xml:id="sec-s4s-sysctl">
  <title>Tuning Kernel Parameters Manually Using <command>sysctl</command></title>
  <para>
   In addition to or instead of tuning kernel parameters using
   &sapconf;/&saptune;, you can also use <command>sysctl</command> to
   make manual adjustments to kernel parameters. However, such changes using
   <command>sysctl</command> do not persist across reboots by default. To
   make them persist across reboots, add them to one of the configuration
   files read by <command>sysctl</command>).
  </para>
  <para>
   <!-- FIXME: -> SLES docs: we don't seem to have any good section to
   reference here. This will do for the moment. - sknorr, 2017-05-04 -->
   For more information about <command>sysctl</command>, see the man pages
    <literal>sysctl(8)</literal>, <literal>sysctl.conf(5)</literal>, and
    <literal>sysctl.d(5)</literal>. </para>
 </sect1>
</chapter>
