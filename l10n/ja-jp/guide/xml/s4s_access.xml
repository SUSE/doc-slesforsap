<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="s4s_access.xml" version="5.0" xml:id="cha-access">
 <title>ファイアウォールの設定</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  この章では、ファイアウォールおよび暗号化を使用してシステムへのアクセスを制限する方法およびシステムにリモート接続する方法について説明します。
 </para>

 <sect1 xml:id="sec-configure-firewall">
  <title><systemitem class="daemon">firewalld</systemitem>の構成</title>

  <para>
   デフォルトで、SUSE Linux Enterprise Server for SAP applicationsのインストールワークフローにより、<systemitem class="daemon">firewalld</systemitem>が有効になっています。
  </para>

  <note>
   
   <title>SuSEfirewall2に代わる<systemitem class="daemon">firewalld</systemitem></title>
   <para>
    SUSE Linux Enterprise Server for SAP applications 15では、SuSEfirewall2に代わる、新しいデフォルトのソフトウェアファイアウォールとして、<systemitem class="daemon">firewalld</systemitem>が導入されています。SuSEfirewall2はSUSE Linux Enterprise Server for SAP applications 15から削除されておらず、引き続きメインリポジトリの一部となっていますが、デフォルトではインストールされません。SUSE Linux Enterprise Server for SAP applications 15より古いリリースからアップグレードしている場合、SuSEfirewall2は変更されず、<systemitem class="daemon">firewalld</systemitem>に手動でアップグレードする必要があります(『Security and Hardening Guide』を参照)。
   </para>
  </note>
  <para>
   ファイアウォールは次のコンポーネントのネットワークアクセスを可能にするように手動で設定する必要があります。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     SAPアプリケーション
    </para>
   </listitem>
   <listitem>
    <para>
     データベース(データベースベンダーのドキュメントを参照。SAP HANAの場合は、<xref linkend="sec-configure-firewall-hana"/>を参照)
    </para>
   </listitem>
  </itemizedlist>
  <para>
   さらに、ポート<literal>1128</literal> (TCP)と<literal>1129</literal> (UDP)を開きます。
  </para>

  <para>
   SAPアプリケーションでは、ファイアウォール内に複数の開いたポートとポート範囲が必要です正確な番号は選択したインスタンスによって異なります。詳細については、SAPによって提供されるドキュメントを参照してください。
  </para>
 </sect1>

 <sect1 xml:id="sec-configure-firewall-hana">
  <title>HANA-Firewallの設定</title>

  <para>
   SAP HANAのファイアウォールの設定を簡素化するために、パッケージ <package>HANA-Firewall</package>.HANA-Firewallは、既存のSuSEfirewall2設定にルールセットを追加します。
  </para>
  <para>
   HANA-Firewallは、次のパートで構成されます。
  </para>
  <itemizedlist>
   <listitem>
    <formalpara>
     <title>YaSTモジュール<guimenu>SAP HANA Firewall (SAP HANAファイアウォール)</guimenu></title>
     <para>
      グラフィカルユーザインタフェースからSAP HANAのファイアウォールルールを設定し、適用し、元に戻すことができます。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>コマンドラインユーティリティ<systemitem>hana-firewall</systemitem></title>
     <para>
      SAP HANAのファイアウォールルールを含むXMLファイルを作成します。
     </para>
    </formalpara>
    <para>
     YaSTを使用する代わりに、<filename>/etc/sysconfig/hana-firewall</filename>にある設定ファイルを使用してファイアウォールルールを設定できます。
    </para>
   </listitem>
  </itemizedlist>

  <important>
   <title>SAP HANA MDCデータベース</title>
   <para>
    マルチテナントSAP HANA (MDC)データベースの場合、開く必要があるポート番号を自動的に判断することはまだできません。マルチテナントSAP HANAデータベースシステムで作業している場合は、YaSTを使用する前にスクリプトを実行して新しいサービス定義を作成します。
   </para>
<screen><prompt role="root"># </prompt><command>cd /etc/hana-firewall.d</command>
<prompt role="root"># </prompt><command>hana-firewall define-new-hana-service</command></screen>
   <para>
    このスクリプトは、開く必要があるTCPポートおよびUDPポートの範囲を含む一連の質問を提示します。
   </para>
  </important>

  <note>
   <title>HANA-Firewallパッケージのインストール</title>
   <para>
    続行する前に、パッケージ<package>HANA-Firewall</package>および<package>yast2-hana-firewall</package>がインストールされていることを確認します。
   </para>
  </note>

  <procedure>
   <title>HANA-Firewallの使用</title>
   <step>
    <para>
     ファイアウォールを設定するSAP HANAデータベースが正しくインストールされていることを確認します。
    </para>
   </step>
   <step>
    <para>
     適切なYaSTモジュールを開くには、<menuchoice><guimenu>アプリケーション</guimenu> <guimenu>YaST</guimenu></menuchoice>の順に選択し、<menuchoice><guimenu>セキュリティとユーザ</guimenu> <guimenu>SAP HANAのシステムファイアウォールの設定</guimenu></menuchoice>の順に選択します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>グローバルオプション</guimenu>で、<guimenu>firewalldを有効化して再読み込み</guimenu>を有効にします。
    </para>
   </step>
   <step>
    <para>
    <guimenu>ゾーン</guimenu>ドロップダウンリストから目的のゾーンを選択し、右矢印ボタンを使用して必要なサービスを追加します。
    </para>
    <para>
     事前設定されたサービス以外のサービスを追加するには、次の表記を使用します。
    </para>
<screen><replaceable>SERVICE_NAME</replaceable>:<replaceable>CIDR_NOTATION</replaceable></screen>
    <para>
     CIDR表記の詳細については、<link xlink:href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing"></link>を参照してください。システムで使用可能なサービスを見つけるには、<command>getent services</command>を使用します。
    </para>
   </step>
   <step>
    <para>
     設定が終了したら、<guimenu>OK</guimenu>をクリックします。
    </para>
    <para>
     HANA-Firewallのファイアウォールルールがコンパイルされて適用されます。次に、サービス<systemitem>hana-firewall</systemitem>が再起動されます。
    </para>
   </step>
   <step>
    <para>
     最後に、HANA-Firewallが正しく有効化されたかどうか確認します。
    </para>
<screen><prompt role="root"># </prompt><command>hana-firewall status</command>
HANA firewall is active. Everything is OK.
</screen>
   </step>
  </procedure>
  <para>
   詳細については、<command>hana-firewall</command>のマニュアルページを参照してください。
  </para>
 </sect1>

 <sect1 xml:id="sec-configure-saprouter">
  <title>SAProuterの統合</title>
  <para>
   SAPのSAProuterソフトウェアを使用すると、異なるSAPシステム間およびSAPシステムと外部ネットワークの間のネットワークトラフィックをプロキシ化できます。SUSE Linux Enterprise Server for SAP applicationsはSAProuterを<systemitem class="daemon">systemd</systemitem>に統合できるようになりました。つまり、SAProuterはオペレーティングシステムによって適切に開始および停止され、<command>systemctl</command>を使用して制御できます。
  </para>
  <para>
   この機能を使用するには、その前に、次のものがこの順序でインストールされていることを確認してください。
  </para>
  <itemizedlist>
   <listitem>
    <para>
     SAProuterを含むSAPアプリケーション
    </para>
   </listitem>
   <listitem>
    <para>
     <package>saprouter-systemd</package>としてパッケージ化されているSAProuter systemdの統合
    </para>
   </listitem>
  </itemizedlist>
  <para>
   最初にインストールするアプリケーションの順序が間違っている場合は、<package>saprouter-systemd</package>を再インストールします。
  </para>
  <para>
   <command>systemctl</command>を使用してSAProuterを制御するには、次を使用します。
  </para>
  <itemizedlist>
   <listitem>
    <para>
     SAProuterサービスの有効化: <command>systemctl enable saprouter</command>
    </para>
   </listitem>
   <listitem>
    <para>
     SAProuterサービスの開始: <command>systemctl start saprouter</command>
    </para>
   </listitem>
   <listitem>
    <para>
     SAProuterサービスのステータスの表示: <command>systemctl status saprouter</command>
    </para>
   </listitem>
   <listitem>
    <para>
     SAProuterサービスの停止: <command>systemctl stop saprouter</command>
    </para>
   </listitem>
   <listitem>
    <para>
     SAProuterサービスの無効化: <command>systemctl disable saprouter</command>
    </para>
   </listitem>
  </itemizedlist>
 </sect1>

 <sect1 xml:id="sec-secure-dns">
  <title>DNSのセキュリティ保護</title>
  <para>
    Linuxシステムでは、ほとんどのアプリケーションはglibc POSIXスタイルのAPIを使用してホスト名の解決を実行します。内部的には、glibcは「ネームサービススイッチ」(NSS)フレームワークを使用して、これらの解決要求をさまざまな設定済みツールに委任します。NSSの設定は<filename>/etc/nsswitch.conf</filename>ファイルにあります。ホスト名解決には以下の複数の組み込みの種類が利用可能です。
  </para>
  <itemizedlist>
  <listitem>
  <para>
    ファイル:この方法では、ホスト名とIPアドレスの静的マッピングを含む<filename>/etc/hosts</filename>ファイルを使用します。
  </para>
  </listitem>
  <listitem>
  <para>
    dns:このオプションでは、glibcの組み込みのDNSリゾルバを利用します。DNSリゾルバは<filename>/etc/resolv.conf</filename>ファイルで設定します。
  </para>
  </listitem>
  </itemizedlist>

  <para>
    従来のDNSプロトコル特有のセキュリティの脆弱性を解決するために、プロトコルレベルのソリューションがいくつも開発されてきました。
  </para>

  <para>
    DNS over TLSおよびDNS over HTTPSの方式では、DNSクエリを暗号化されたTLS接続上で直接送信するか(DoT)、HTTPS内に埋め込んで送信する(DoH)ことにより、セキュリティを強化することを目的としています。
  </para>
  <para>
    DNSSECでは、暗号化技術によってDNSクエリに署名し、応答の受信時にこれらの署名を検証します。DNSSECが正しく機能するには、解決プロセスに関与するすべてのDNSサーバがDNSSECをサポートするように設定されている必要があります。
  </para>
  <para>
    Linuxでは、安全なDNS解決を容易にするために複数の実装が利用可能です。
  </para>
  <para>
    systemd <literal>resolved</literal>コンポーネントは安全なDNS解決サービスを提供します。systemd <literal>resolved nameservice</literal>プラグインは、glibcネームサービススイッチ(NSS)フレームワークとの統合をサポートします。<literal>resolved</literal>の一部である<package>systemd-network</package>パッケージはPackageHubで入手可能です。
  </para>
  <para>
    <literal>resolved</literal>を設定するには、次のように<literal>resolve</literal>を<filename>/etc/nsswitch.conf</filename>ファイルの<literal>hosts</literal>の行に追加します。
  </para>
<screen>hosts:          mymachines resolve [!UNAVAIL=return] files myhostname dns</screen>
  <para>
    DNSクエリを<literal>localhost:dns</literal>に転送することで、<literal>resolved</literal>をローカルリゾルバとして使用できます。
  </para>
  <para>
    次のコマンドを実行して、<literal>resolved</literal>サービスを起動します。
  </para>
<screen><prompt role="root"># </prompt>systemctl enable systemd-resolved.service
  <prompt role="root"># </prompt>systemctl start systemd-resolved.service</screen>
  <para>
    <literal>resolved</literal>をセキュアDNS用に設定するには、<filename>/etc/systemd/resolved.conf.d/</filename>ディレクトリにある<filename>resolved.conf</filename>設定ファイルを使用します。
  </para>
  <para>
    DNSSECの場合、設定は次のようになります。
  </para>
<screen>
[Resolve]
# Add your local resolvers below:
DNS=192.168.178.1
DNSSEC=on
</screen>
<para>
  もう1つのアプローチはUnboundネームサーバを介してDNSを保護することです。このネームサーバはDNSフォワーダとして機能することができ、通常のDNSクエリをセキュアDNSプロトコルに変換可能です。Unboundを使用するには、通常はローカルでセットアップしてから、<filename>/etc/resolv.conf</filename>ファイルを、ローカルのUnboundインスタンスを指すように設定します。
</para>
<para>
  SUSEのデフォルト設定では、UnboundはデフォルトでDNSSECの検証を実行します。<literal>unbound-anchor</literal>サービスは、標準のISCルートキーを取得する役割を担います。
</para>
  </sect1>
</chapter>
