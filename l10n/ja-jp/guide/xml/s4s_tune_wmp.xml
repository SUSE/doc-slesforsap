<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="s4s_tune_wmp.xml" xml:id="sec-memory-protection" version="5.0">
    <title>ワークロードメモリ保護のチューニング</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

    <para>
        SAPアプリケーションを物理メモリに保持することは、パフォーマンスのために不可欠です。SUSE Linux Enterprise Server for SAP applications 11 SP1以降およびSUSE Linux Enterprise Server for SAP applications 12では、ページキャッシュ制限により、ページキャッシュの増加によるディスクへのスワップアウトを防止していました。SUSE Linux Enterprise Server for SAP applications 15では、ページキャッシュ制限がより高度なワークロードメモリ保護に置き換えられました。
    </para>
    <para>
        ワークロードメモリ保護は、SAPインスタンスを専用のcgroup (v2)に置き、<varname>memory.low</varname>パラメータによって、物理メモリに保持するメモリ容量をカーネルに伝えます。これにより、ページキャッシュの増加を含む、そのcgroupの外側のあらゆる形態のメモリ負荷に対してこのcgroup内のプロセスが保護されます。ワークロードメモリ保護は、このcgroup内のメモリ負荷に対して保護することはできません。これは、1つのホスト上の「<emphasis>すべての</emphasis>」インスタンスのメモリをカバーします。
    </para>
    <para>
        <varname>memory.low</varname>の値は、SAPインスタンスとワークロードの種類によって異なり、手動で設定する必要があります。システムが過度な負荷下にある場合、Linuxカーネルは<varname>memory.low</varname>値を無視して、OOMキラーをスワップしたり、呼び出したりしてでも、システム全体を安定化させようとします。
    </para>
    <para>
        cgroupに関する詳細については、<link xlink:href="https://documentation.suse.com/sles/15-SP2/html/SLES-all/cha-tuning-cgroups.html"/>を参照してください。
    </para>

    <sect2 xml:id="sec-memory-protection-architecture">
        <title>アーキテクチャ</title>
        <para>WMPは次の3つのコンポーネントに依存します。</para>
        <variablelist>
            <varlistentry>
                <term>cgroup2メモリコントローラ(Linuxカーネル)</term>
                <listitem>
                    <para>
                        cgroup2メモリコントローラパラメータ
                        <parameter>memory.low</parameter> では、Linuxカーネルが物理メモリに保持するメモリ容量を定義できます。このメモリ容量は、システム全体が重大なメモリ状況にある場合を除いて、再利用プロセスから除外されます。
                    </para>
                    <para>
                        WMPは <parameter>memory.low</parameter> を使用して、SAPプロセスのメモリがページングされ、ディスクにページアウトされるのを防止します。メモリコントローラを除く、Cgroup1コントローラは、まだ使用可能ですが、マウントされていません。
                    </para>
                </listitem>
            </varlistentry>
            <varlistentry>
                <term><systemitem class="daemon">systemd</systemitem></term>
                <listitem>
                    <para>
                        Systemdでは、cgroup階層を作成および維持するためのインフラストラクチャを提供し、cgroupパラメータの設定も可能にします。WMPには、<systemitem class="daemon">systemd</systemitem>設定ファイルが付属し、 <parameter>memory.low</parameter>
                        の設定が<systemitem class="daemon">systemd</systemitem>メソッドを使用して簡単に行えます。
                    </para>
                </listitem>
            </varlistentry>
            <varlistentry>
                <term>SAP Start Service</term>
                <listitem>
                    <para>
                        SAP Start Service (<systemitem>sapstartsrv</systemitem>)は、SAPインスタンスの開始と停止を管理します。WMPの重要な機能は、インスタンス自体がインスタンスプロファイルで開始される前の、プログラムの設定可能な実行にあります。WMPでは、このメソッドを使用してプログラムを呼び出し、<systemitem>sapstartsrv</systemitem>/<systemitem>sapstart</systemitem>プロセスを指定のcgroupに移動させるため、SAPインスタンスがそのcgroup内で開始されます。
                    </para>
                </listitem>
            </varlistentry>
        </variablelist>
    </sect2>

    <sect2 xml:id="sec-memory-protection-support">
        <title>ワークロードメモリ保護のサポート</title>
        <para>WMPは、</para>
        <itemizedlist>
            <listitem>
                <para>App Server (SAP NetWeaver、SAP S/4HANA)や</para>
            </listitem>
            <listitem>
                <para>SAP HANA 1.0/2.0など1台のホスト上にある1台以上のSAPシステム用Intel 64/AMD64上のSUSE Linux Enterprise Server for SAP applications 15 SP2でサポートされています。</para>
            </listitem>
        </itemizedlist>

        <para>
            ワークロードメモリ保護は、SAP HANA以外のデータベースには適用されません。開始メソッドによって、プロセスが専用のcgroup内部または外部で実行される場合があります。内部で実行される場合、<varname>memory.low</varname>を決定する際にメモリ消費量を考慮する必要があります。
        </para>

        <important>
            <title>WMPの制限</title>
            <para>
                WMPを使用することはメリットがありますが、いくつかの制限事項に注意する必要があります。
            </para>
            <itemizedlist>
                <listitem>
                    <para>
                        WMPは専用のcgroup内部のメモリ負荷に対して保護できません。
                    </para>
                </listitem>
                <listitem>
                    <para>
                        WMPはSAPシステムまたはそのインスタンスを相互に保護できません。すべてのSAPプロセスは同じメモリ制限を共有します。複数のSAPシステム(SAP NetWeaverやSAP S/4HANA)がある場合、WMPは1つのSAPアプリケーションを別のSAPアプリケーションから保護できません。 </para>
                </listitem>
                <listitem>
                    <para>
                        SUSEのHAクラスタソリューションのサポートはまだ使用できません。
                    </para>
                </listitem>
            </itemizedlist>
        </important>

    </sect2>

    <sect2 xml:id="sec-memory-protection-setup">
        <title>ワークロードメモリ保護の設定</title>
        <remark>toms 2020-09-28: Some introduction para is missing here.</remark>
        <sect3 xml:id="sec-memory-protection-setup-preparation">
            <title>ワークロードメモリ保護の準備</title>
            <procedure>
                <step>
                    <para>
                        SAPソフトウェア(SAP HANA、SAP NetWeaverなど)がインストールされているか確認します。グループ<systemitem class="groupname">sapsys</systemitem>は、後で <package>sapwmp</package>
                        のパッケージインストール中に必要です。その部分をスキップする場合は、警告メッセージが表示されます(<xref linkend="adm-order-of-packages"/>を参照)。
                    </para>
                </step>
                <step>
                    <para>
                        SAPシステムの停止:
                    </para>
                    <screen><prompt role="root">root # </prompt><command>systemctl</command> stop sapinit</screen>
                    <para>
                        サービスは有効にすることができますが、すべてのSAPプロセスを終了する必要があります。
                    </para>
                </step>
                <step>
                    <para>パッケージ <package>sapwmp</package>のインストール:</para>
                    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>zypper</command> install sapwmp</screen>
                    <important xml:id="adm-order-of-packages">
                        <title>パッケージの順番に注意する</title>
                        <para>次のメッセージは、SAPソフトウェアがシステムにインストールされていない場合にのみ表示されます。</para>
                        <screen>Warning: sapsys group not found warning: group sapsys does not exist - using root</screen>
                        <para>パッケージ <package>sapwmp</package> を削除し、SAPソフトウェアをインストールしてから、パッケージを再びインストールします。
                        </para>
                        <para>別の方法として、SAPソフトウェアをインストールした「<emphasis>後で</emphasis>」次のコマンドを使用して、所有権と許可を修正できます。</para>
                        <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>chgrp</command> sapsys /usr/lib/sapwmp/sapwmp-capture &amp;&amp; \
chmod +s /usr/lib/sapwmp/sapwmp-capture</screen>
                    </important>
                    <para>次のメッセージは無視して構いません。</para>
                    <screen>Warning: Found memory controller on v1 hierarchy. Make sure unified hierarchy only is used.</screen>
                    <para>次の手順で、統合階層への切り替えを実行します。</para>
                </step>
                <step>
                    <para><varname>systemd.unified_cgroup_hierarchy=true</varname>をカーネルコマンドラインに追加するには、次のように<filename>/etc/default/grub</filename>の<varname>GRUB_CMDLINE_LINUX_DEFAULT</varname>にこれを追加します。</para>
                    <screen>GRUB_CMDLINE_LINUX_DEFAULT="... systemd.unified_cgroup_hierarchy=true swapaccount=1"</screen>
                    <para>
                        この変更により、cgroup2コントローラのみが<filename>/sys/fs/cgroup</filename>にマウントされます。ただし、メモリコントローラを除き、Cgroup1コントローラは、まだ利用可能です。cgroup1を使用するツールは、そのままでは機能せず、設定が必要な場合があります。また、cgroup1に必要なマウント構造を提供する必要があります。
                    </para>
                    <para>
                        パラメータ<varname>swapaccount=1</varname>は、WMPが機能するために必要ではありませんが、サポートケースでの分析を支援し、cgroupごとのスワップアウトされたメモリ容量を示します。
                    </para>
                </step>
                <step>
                    <para>GRUB2の設定を再書き込みします。</para>
                    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>grub2-mkconfig</command> -o /boot/grub2/grub.cfg</screen>
                    <para>再起動後(後で実行される)、cgroup階層はv2 (統合階層)のみに切り替えられます。</para>
                </step>
                <step xml:id="st-conf-memorylow-sap-slice">
                    <para><systemitem>SAP.slice</systemitem>用の<varname>MemoryLow</varname>を設定します。</para>
                    <screen><prompt>tux &gt; </prompt><command>sudo</command> <command>systemctl</command> set-property SAP.slice MemoryLow=...</screen>
                    <para>
                        このコマンドは、<filename>/etc/systemd/system.control/SAP.slice.d/</filename>にドロップインを作成し、<varname>MemoryLow</varname>を設定します。
                    </para>
                    <para>
                        <package>sapwmp</package> のパッケージ には、SAPインスタンスに同じ名前のcgroupを作成するシステム設定<systemitem>SAP.slice</systemitem>が含まれます。<varname>MemoryLow</varname>は、最初に述べたcgroupパラメータ<varname>memory.low</varname>と等価なsystemdです。<varname>MemoryLow</varname>の値は、SAPアプリケーションおよびワークロードのタイプによって異なります。
                    </para>
                    <variablelist>
                        <varlistentry>
                            <term>SAP HANAの場合</term>
                            <listitem>
                                <para>
                                    SAP HANAにはグローバル割り当て制限があるため、その値を直接使用できます。
                                </para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term>SAPアプリケーションサーバ(SAP NetWeaver、SAP S/4HANA)</term>
                            <listitem>
                                <para>
                                    アプリケーションサーバの場合、ワークロードのサイジングは<varname>MemoryLow</varname>の値を示す必要があります。<package>sapwmp</package> のパッケージ には、<varname>MemoryLow</varname>を決定するために役立つ可能性がある監視パートが含まれます。<xref linkend="sec-memory-protection-operation-monitor-memory-usage"/>を参照してください。
                                </para>
                            </listitem>
                        </varlistentry>
                    </variablelist>
                    <para>
                        次の点に注意してください。
                    </para>
                    <itemizedlist>
                        <listitem>
                            <para>
                                1台のホスト上のすべてのSAPインスタンスは、<systemitem>SAP.slice</systemitem>内に存在します。<varname>MemoryLow</varname>は、そのホスト上の「<emphasis>すべての</emphasis>」インスタンスのメモリ容量をカバーする必要があります。SAPシステムまたはそのインスタンスを相互に保護することはできません。
                            </para>
                        </listitem>
                        <listitem>
                            <para>
                                SAP HANA以外のデータベースを使用している場合、一部のデータベースプロセスが<systemitem>SAP.slice</systemitem>に含まれている可能性があります。<varname>MemoryLow</varname>値を決定する際には、これらのメモリ消費量を考慮する必要があります。
                            </para>
                        </listitem>
                        <listitem>
                            <para>
                                <varname>MemoryLow</varname>の値は、物理メモリの値に非常に近い値、またはこれらの値より大きな値にしないでください。システムサービスおよび追加のインストール済みソフトウェアにもメモリが必要です。SAPアプリケーションを犠牲にしてスワップを広範囲に使用しなければならない場合、システムが応答しなくなる可能性があります。
                            </para>
                        </listitem>
                    </itemizedlist>
                    <note>
                        <title><varname>MemoryLow</varname>値を正しく計算する</title>
                        <para>
                            <varname>MemoryLow</varname>は、メモリサイズをバイト単位で取得します。値の末尾にK、M、G、Tが付いている場合、指定されたメモリサイズはそれぞれ、キビバイト、メビバイト、ギビバイト、またはテビバイトとして解析されます(1000ではなく、1024をベースとしている場合は、<link xlink:href="https://en.wikipedia.org/wiki/Binary_prefix"/>を参照)。または、パーセンテージ値が指定される場合があります。この場合、システムにインストールされている物理メモリを基準として取得されます。
                        </para>
                        <para>
                            基礎となるcgroupメモリコントローラは、値をページサイズの倍数に切り上げます。混乱を避けるため、<varname>MemoryLow</varname>の値としてページサイズの倍数をすでに設定しています。
                        </para>
                    </note>
                </step>
                <step>
                    <para>
                        各SAPインスタンスプロファイルのバックアップを作成します。プロファイルのエラーはSAPシステムの起動を妨げる可能性があります。
                    </para>
                </step>
                <step>
                    <para>SAPインスタンスごとに、次の行を最後の<literal>Execute_</literal>行の後のインスタンスプロファイル(通常は<filename>/usr/sap/<replaceable>SID</replaceable>/SYS/profile/</filename>にある)に追加します。</para>
                    <screen>Execute_20 = local /usr/lib/sapwmp/sapwmp-capture -a</screen>
                    <para>
                        必要に応じてExecuteステートメント数を増やして最大にし、行が最後に実行されるようにします。
                    </para>
                    <important>
                        <para>SAP GUI (トランザクションRZ11)によって管理するためにデータベースにプロファイルをインポートしていない場合「<emphasis role="strong">にのみ</emphasis>」インスタンスプロファイルを直接編集します。これを実行する場合は、SAP GUIを使用して、行を追加してください。ファイルシステムにあるプロファイルファイルは上書きされ、手動の変更は失われます。</para>
                    </important>
                </step>
            </procedure>
            <para>これでシステムが再起動する準備が整いました。</para>
        </sect3>
        <sect3 xml:id="sec-memory-protection-reboot-and-verification">
            <title>再起動と確認</title>
            <remark>toms 2020-09-16: introduction of the procedure is missing.</remark>
            <procedure>
                <step>
                    <para>システムを再起動します。</para>
                </step>
                <step>
                    <para>再起動後、実際にcgroups v2が使用されていることを確認します。</para>
                    <screen><prompt role="root">root # </prompt><command>grep</command>  cgroup /proc/mounts
cgroup /sys/fs/cgroup cgroup2 rw,nosuid,nodev,noexec,relatime 0 0</screen>
                </step>
                <step>
                    <para>cgroupが正常に作成され、低いメモリ値が設定されていることを確認します。</para>
                    <screen><prompt>tux &gt; </prompt><command>systemctl</command> show -p MemoryLow SAP.slice
MemoryLow=18487889920    &lt;- Should be your chosen value (always in bytes)!

# cat /sys/fs/cgroup/SAP.slice/memory.low
18487889920    &lt;- Should be your chosen value!</screen>
                    <para>
                        変数<varname>MemoryLow</varname>は任意の値に設定できますが、変数のコンテンツは常にページサイズの倍数になります。両方の値にわずかに違いがあることに気づく場合には、このことに注意してください。
                    </para>
                </step>
                <step>
                    <para>すべてのSAPインスタンスプロセスが正しいシステムのスライス/cgroup内にあることを確認します。</para>
                    <para><systemitem class="service">sapinit.service</systemitem>を有効にしていない場合は、今すぐサービスを開始してください。自動開始がインスタンスプロファイルで有効になっていない場合は、確認する前にインスタンスを開始します。</para>
                    <para>例:</para>
                    <screen><prompt role="root">root # </prompt><command>systemd-cgls</command> -a /sys/fs/cgroup/SAP.slice
Directory /sys/fs/cgroup/SAP.slice:
|-wmp-rd91fd6b3ca0d4c1183659ef4f9a092fa.scope
| |-2707 /usr/sap/HA0/ERS10/exe/sapstartsrv pf=/usr/sap/HA0/ERS10/profile/H...
| |-3349 sapstart pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er
| `-3375 er.sapHA0_ERS10 pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er N...
|-wmp-r360ebfe09bcd4df4873ef69898576199.scope
| |-3128 /usr/sap/HA0/D01/exe/sapstartsrv pf=/usr/sap/HA0/SYS/profile/HA0_D...
| |-3572 sapstart pf=/usr/sap/HA0/SYS/profile/HA0_D01_sapha0ci
| |-3624 dw.sapHA0_D01 pf=/usr/sap/HA0/SYS/profile/HA0_D01_sapha0ci
...</screen>
                    <para>インスタンスごとに、このインスタンスのすべてのプロセスを含むディレクトリ<filename>wmp-r<replaceable>SCOPEID</replaceable>.scope</filename>が存在します。<replaceable>SCOPEID</replaceable>は、16進数の128ビットランダム値です。</para>
                    <para>SAP HostAgentは、WMPではカバーされておらず、一部は<systemitem>sapinit.slice</systemitem>に残り、一部は<systemitem>sapadm</systemitem>のユーザスライスに残ります。</para>
                </step>
                <step>
                    <para>プロセスがcgroup内にない場合は、インスタンスプロファイルの<literal>Execute</literal>行が正しいかどうか確認します。また、各インスタンスの開始が、システムログ<filename>/var/log/messages</filename>に記録されます。</para>
                    <screen>...
2020-06-16T18:41:28.317233+02:00 server-03 sapwmp-capture: Found PIDs:
2020-06-16T18:41:28.317624+02:00 server-03 sapwmp-capture:      17001
2020-06-16T18:41:28.317813+02:00 server-03 sapwmp-capture:      16994
2020-06-16T18:41:28.317959+02:00 server-03 sapwmp-capture:      16551
2020-06-16T18:41:28.319423+02:00 server-03 sapwmp-capture: Successful capture into SAP.slice/wmp-r07a27e12d7f2491f8ccb9aeb0e080aaa.scope
2020-06-16T18:41:28.319672+02:00 server-03 systemd[1]: Started wmp-r07a27e12d7f2491f8ccb9aeb0e080aaa.scope.
...</screen>

                </step>
            </procedure>
            <tip>
                <para> WMPセットアップを確認するスクリプトは次の場所にあります:。 <link xlink:href="https://github.com/scmschmidt/wmp_check"/>。
                </para>
            </tip>
        </sect3>
    </sect2>

    <sect2 xml:id="sec-memory-protection-configuration">
        <title>ワークロードメモリ保護の設定</title>
        <para>WMPを設定するには、次のように<filename>/etc/sapwmp.conf</filename>を編集します。</para>
        <screen># NOTE: Local changes may be reverted after update of WMP package. Check for
#      .rpmsave file to restore &amp; merge changes.

## Description: Slice unit name where workload is put into
## Type:        string
## Default:     "SAP.slice"
DEFAULT_SLICE="SAP.slice"

## Description: Comma-separated list of command names to which capture is
##              applied (matching against /proc/$PID/stat)
## Type:        string
## Default:     sapstart,sapstartsrv
PARENT_COMMANDS=sapstart,sapstartsrv</screen>
        <para>変更後、すべてのSAPインスタンスを再起動します。</para>
        <warning>
            <para><filename>/etc/sapwmp.conf</filename>を変更する必要はありません。すべき操作を正確に認識するまで実行しないでください。</para>
        </warning>
    </sect2>

    <sect2 xml:id="sec-memory-protection-operation-change-the-value-of-memorylow">
        <title>MemoryLowの値の変更</title>
        <para><varname>MemoryLow</varname>の値を変更するには、次のコマンドを実行します。</para>
        <screen><prompt role="root">root # </prompt><command>systemctl</command> set-property SAP.slice MemoryLow=...</screen>
        <para>変更はすぐに有効になります。</para>
        <para>
            基礎となるcgroupメモリコントローラは、値をページサイズの倍数に切り上げます。混乱を避けるため、<varname>MemoryLow</varname>の値としてページサイズの倍数を設定します。
        </para>
        <important>
            <para><varname>MemoryLow</varname>をすでに<systemitem>SAP.slice</systemitem>に割り当てられているメモリより小さい値に設定しないでください。確認するには、次のコマンドを実行します。</para>
            <screen><prompt role="root">root # </prompt><command>systemctl</command> show -p MemoryCurrent SAP.slice</screen>
        </important>
    </sect2>
    <sect2 xml:id="sec-memory-protection-operation-monitor-memory-usage">
        <title>メモリ使用量の監視</title>
        <para>メモリ使用量のログを記録することが、<varname>memory.low</varname>の値を決定するために必要な場合がありますが、WMPの正しい動作を監視するためにも必要になる場合があります。</para>
        <para>モニタリングを有効にするには、付属しているタイマーユニットを有効にします。</para>
        <screen><prompt role="root">root # </prompt><command>systemctl</command> enable --now wmp-sample-memory.timer</screen>
        <para>これで、タイマーが<command>systemctl list-timers</command>によって一覧表示されるはずです。</para>
        <screen><prompt role="root">root # </prompt><command>systemctl</command> list-timers
NEXT    LEFT       LAST    PASSED  UNIT                     ACTIVATES
...
Tue...  9min left  Tue...  4s ago  wmp-sample-memory.timer  wmp-sample-memory.service
...</screen>
        <para>現在の設定を確認すると、メモリデータが10分ごとに収集され、3分のランダムな遅延が発生していることがわかります。</para>
        <screen><prompt role="root">root # </prompt><command>systemctl</command> cat wmp-sample-memory.timer
# /usr/lib/systemd/system/wmp-sample-memory.timer
[Unit]
Description=WMP periodic log of memory consumption

[Timer]
OnCalendar=*:0/10
RandomizedDelaySec=180
AccuracySec=60

[Install]
WantedBy=timers.target</screen>
        <para>これを変更するには、ドロップインファイルを作成して、systemdをリロードします(たとえば、間隔を30分に増やします):</para>
        <screen><prompt role="root">root # </prompt><command>mkdir</command> /etc/systemd/system/wmp-sample-memory.timer.d

# cat &lt;&lt;EOF &gt;/etc/systemd/system/wmp-sample-memory.timer.d/override.conf
[Timer]
OnCalendar=
OnCalendar=*:0/30
EOF

# systemctl daemon-reload</screen>
        <para>
            <emphasis>(以前の定義されたOnCalendar=設定を削除するには、最初のOnCalendar=行が重要です。)</emphasis>
        </para>
        <para>メモリ消費量を確認するには、システムログで<literal>wmp_memory_current</literal>で書き込まれた行を確認します。</para>
        <screen><prompt role="root">root # </prompt><command>grep</command> wmp_memory_current /var/log/messages
...


2020-09-14T12:02:40.337266+02:00 server-03 wmp_memory_current: SAP.slice : memory.low=21474836480 memory.current=2294059008 memory.swap.current=0 , user.slice : memory.low=0 memory.current=5499219968 memory.swap.current=0 , init.scope : memory.low=0 memory.current=8364032 memory.swap.current=0 , system.slice : memory.low=0 memory.current=1863335936 memory.swap.current=0
2020-09-14T12:03:00.767838+02:00 server-03 wmp_memory_current: SAP.slice : memory.low=21474836480 memory.current=2294022144 memory.swap.current=0 , user.slice : memory.low=0 memory.current=5499473920 memory.swap.current=0 , init.scope : memory.low=0 memory.current=8364032 memory.swap.current=0 , system.slice : memory.low=0 memory.current=1862586368 memory.swap.current=0
2020-09-14T12:04:00.337315+02:00 server-03 wmp_memory_current: SAP.slice : memory.low=21474836480 memory.current=2294022144 memory.swap.current=0 , user.slice : memory.low=0 memory.current=5499207680 memory.swap.current=0 , init.scope : memory.low=0 memory.current=8355840 memory.swap.current=0 , system.slice : memory.low=0 memory.current=1862746112 memory.swap.current=0
...</screen>
        <para>ここによりよい印象を与える再フォーマットされたログ行があります。</para>
        <screen>2020-09-14T12:02:40.337266+02:00 server-03 wmp_memory_current:
SAP.slice    : memory.low=21474836480 memory.current=2294059008 memory.swap.current=0 ,
user.slice   : memory.low=0           memory.current=5499219968 memory.swap.current=0 ,
init.scope   : memory.low=0           memory.current=8364032    memory.swap.current=0 ,
system.slice : memory.low=0           memory.current=1863335936 memory.swap.current=0</screen>
        <para><filename>/sys/fs/cgroup/</filename>の直下のcgroupごとにコンマで区切られた1つのブロックが存在します。通常のシステムでは、少なくとも<systemitem>user.slice</systemitem>、<systemitem>system.slice</systemitem>、および<systemitem>init.scope</systemitem>を見つける必要があります。WMPは<systemitem>SAP.slice</systemitem>を追加します。</para>
        <para>各ブロックには、<varname>memory.low</varname>および<varname>memory.current</varname>の現在の値に関する情報が含まれています。この情報は、このcgroup内プロセスの物理メモリに現在割り当てられている量です。
        </para>
        <para>
            セットアップ中にスワップアカウンティング(<varname>swapaccount=1</varname>)を有効にしている場合は、cgroupのスワップアウトされたメモリ容量である、<varname>memory.swap.current</varname>もあります。
        </para>
        <para>すべての値はバイト単位です。<xref linkend="sec-memory-protection-setup-preparation"/>の<xref linkend="st-conf-memorylow-sap-slice"/>を参照してください。</para>

        <tip>
            <para>テーブルまたはCSVとして情報を出力するスクリプトは次の場所にあります。<link xlink:href="https://github.com/scmschmidt/wmp_log_extract"/>
            </para>
        </tip>
    </sect2>

    <sect2 xml:id="sec-memory-protection-verify-correct-operation">
        <title>正しい運用の確認</title>
        <para>メモリ消費量およびスワッピングの監視(<xref linkend="sec-memory-protection-operation-monitor-memory-usage"/>を参照)のほか、すべてのSAPインスタンスプロセスが<systemitem>SAP.slice</systemitem>の下のスコープ内であることも定期的に確認する必要があります。</para>
        <para>これを行うには、「<command>systemd-cgls</command>」を実行し、各インスタンスプロセスを確認します。</para>
        <para>例:</para>
        <screen><prompt role="root">root # </prompt><command>systemd-cgls</command> -a /sys/fs/cgroup/SAP.slice
Directory /sys/fs/cgroup/SAP.slice:
|-wmp-rd91fd6b3ca0d4c1183659ef4f9a092fa.scope
| |-2707 /usr/sap/HA0/ERS10/exe/sapstartsrv pf=/usr/sap/HA0/ERS10/profile/H...
| |-3349 sapstart pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er
| `-3375 er.sapHA0_ERS10 pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er N...
|-wmp-r360ebfe09bcd4df4873ef69898576199.scope
| |-3128 /usr/sap/HA0/D01/exe/sapstartsrv pf=/usr/sap/HA0/SYS/profile/HA0_D...
| |-3572 sapstart pf=/usr/sap/HA0/SYS/profile/HA0_D01_sapha0ci
| |-3624 dw.sapHA0_D01 pf=/usr/sap/HA0/SYS/profile/HA0_D01_sapha0ci
...</screen>
        <para>より簡単なテストで、システムで使用されるすべての&lt;SID&gt;に対するcgroupを含むすべてのプロセスを一覧表示します。</para>
        <para>例:</para>
        <screen><prompt>tux &gt; </prompt><command>ps</command> -eo user,pid,cgroup:60,args | <command>grep</command> -e [h]a0adm
ha0adm    2062 0::/user.slice/user-1001.slice/user@1001.service/init.scope  /usr/lib/systemd/systemd --user
ha0adm    2065 0::/user.slice/user-1001.slice/user@1001.service/init.scope  (sd-pam)
ha0adm    2480 0::/SAP.slice/wmp-r73c594e050904c9c922a312dd9a28fd4.scope    /usr/sap/HA0/ASCS00/exe/sapstartsrv pf=/usr/sap/HA0/SYS/profile/HA0_ASCS00_sapha0as -D -u ha0adm
ha0adm    2688 0::/SAP.slice/wmp-ra42489517eb846c282c57681e627a496.scope    /usr/sap/HA0/ERS10/exe/sapstartsrv pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er -D -u ha0adm
ha0adm    3081 0::/SAP.slice/wmp-r73c594e050904c9c922a312dd9a28fd4.scope    sapstart pf=/usr/sap/HA0/SYS/profile/HA0_ASCS00_sapha0as
ha0adm    3106 0::/SAP.slice/wmp-r0951160bb5454f4fa32be03a6e8bc98a.scope    /usr/sap/HA0/D01/exe/sapstartsrv pf=/usr/sap/HA0/SYS/profile/HA0_D01_sapha0ci -D -u ha0adm
ha0adm    3133 0::/SAP.slice/wmp-r73c594e050904c9c922a312dd9a28fd4.scope    ms.sapHA0_ASCS00 pf=/usr/sap/HA0/SYS/profile/HA0_ASCS00_sapha0as
ha0adm    3134 0::/SAP.slice/wmp-r73c594e050904c9c922a312dd9a28fd4.scope    en.sapHA0_ASCS00 pf=/usr/sap/HA0/SYS/profile/HA0_ASCS00_sapha0as
ha0adm    3327 0::/SAP.slice/wmp-ra42489517eb846c282c57681e627a496.scope    sapstart pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er
...</screen>
        <para>すべてのインスタンスプロセスは<systemitem>0::/SAP.slice/</systemitem>の下のスコープ内にある必要があります。</para>
        <warning>
            <para><systemitem>sapstartsrv</systemitem>プロセスはユーザスライスに一時的に存在する可能性があります。これは、プロセスが手動で開始されたか、<command>sapcontrol</command>コマンドの実行時にプロセスが欠落して開始された場合に発生します。インスタンスを再起動すると、正常に修正されます。sapstartsrvを除くインスタンスプロセスを<systemitem>SAP.slice</systemitem>の外部で実行しないようにしてください。</para>
        </warning>
    </sect2>

    <sect2 xml:id="sec-memory-protection-deinstallation">
        <title>ワークロードメモリ保護のアンインストール</title>
        <procedure>
            <step>
                <para>SAPシステムを完全に停止します。<systemitem class="service">sapinit.service</systemitem>を停止する必要がありますが、有効なままにしておくことができます。すべてのSAPプロセスを終了する必要があります。</para>
            </step>
            <step>
                <para>設定<varname>MemoryLow</varname>などの<systemitem>SAP.slice</systemitem>に行われた変更をすべて削除します。</para>
                <screen><prompt role="root">root # </prompt><command>systemctl</command> revert SAP.slice</screen>
            </step>
            <step performance="optional">
                <para><package>sapwmp</package> パッケージ の削除:</para>
                <screen><prompt role="root">root # </prompt><command>zypper</command> remove sapwmp</screen>
                <para>
                    このステップはオプションです。パッケージは影響を及ぼすことなくシステムにとどまることができます。
                </para>
            </step>
            <step performance="optional">
                <para><filename>/etc/default/grub</filename>の<varname>GRUB_CMDLINE_LINUX_DEFAULT</varname>から<varname>systemd.unified_cgroup_hierarchy=true</varname>を削除します。
                </para>
                <para>
                    このステップはオプションです。WMPを使用せずにcgroup2を保持できます。
                </para>
            </step>
            <step>
                <para>GRUB2の設定を再書き込みします。</para>
                <screen><prompt role="root">root # </prompt><command>grub2-mkconfig</command> -o /boot/grub2/grub.cfg</screen>
                <para>次のブート後に、システムはハイブリッドcgroup階層に戻されます。</para>
            </step>
            <step>
                <para>各SAPインスタンスプロファイル(通常は<filename>/usr/sap/<replaceable>SID</replaceable>/SYS/profile/</filename>にある)からsapwmp-captureを呼び出す行を削除します。</para>
                <screen>Execute_20 = local /usr/lib/sapwmp/sapwmp-capture -a</screen>
                <important>
                    <title>バックアップが必要</title>
                    <para>インスタンスプロファイルを編集する前に、バックアップを作成してください! プロファイルのエラーはSAPシステムの起動を妨げる可能性があります!</para>
                </important>
                <important>
                    <title>プロファイルを直接編集することについて</title>
                    <para>SAP GUI (トランザクションRZ11)によって管理するためにデータベースにプロファイルをインポートしていない場合「<emphasis role="strong">にのみ</emphasis>」インスタンスプロファイルを直接編集します。これを実行する場合は、SAP GUIを使用して、行を追加してください。ファイルシステムにあるプロファイルファイルは上書きされ、手動の変更は失われます。</para>
                </important>
            </step>
            <step>
                <para>システムを再起動して、SAPシステムが正常に起動されていることを確認します。</para>
            </step>
        </procedure>
    </sect2>

</sect1>
